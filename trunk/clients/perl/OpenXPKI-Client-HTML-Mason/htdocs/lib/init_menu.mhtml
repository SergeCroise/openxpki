<!-- FIXME - integrate DeuBa specific things into menus -->
<%args>
    $nested      => 0,
    $first_level => undef,
    $last_level  => undef,
    $mode        => "DEFAULT",
</%args>

<%once>
    my $CONFIG = {
                ROLE =>
                {
                    '' =>
                    {
                        MENU => "anon_menu",
                    },
                    'User' =>
                    {
                        MENU => "user_menu"
                    },
                    'RA Operator' =>
                    {
                        MENU => "raop_menu"
                    },
                    'CA Operator' =>
                    {
                        MENU => "caop_menu"
                    },
                    'PUK Manager' =>
                    {
                        MENU => 'puk_manager_menu',
                    },
                },
                MENU =>
                {
                    'puk_manager_menu' =>
                    [
                        ["MENU",   "I18N_OPENXPKI_HTML_MENU_CA_INFO",
                                   "ca_info", undef],
                        ["MENU", "I18N_OPENXPKI_HTML_MENU_PUK_MANAGEMENT",
                                   "puk_management", 'I18N_OPENXPKI_WF_TYPE_PASSWORD_SAFE' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LOGOUT",
                                   "logout", undef ]
                    ],
                    "user_menu" =>
                    [
                        ['ACTION', 'I18N_OPENXPKI_HTML_MENU_HOME',
                                   'home', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_REQUEST',
                                   'user_request', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_DOWNLOAD',
                                   'download', undef],
                        ['ACTION',   'I18N_OPENXPKI_HTML_MENU_SEARCH',
                                   'cert_search', undef],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LOGOUT",
                                   "logout", undef ]
                    ],
                    "anon_menu" =>
                    [
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_DOWNLOAD',
                                   'download', undef],
                        ['ACTION',   'I18N_OPENXPKI_HTML_MENU_SEARCH',
                                   'cert_search', undef],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LOGOUT",
                                   "logout", undef ]
                    ],
                    "raop_menu" =>
                    [
                        ['ACTION', 'I18N_OPENXPKI_HTML_MENU_TASKS',
                                   'home', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_REQUEST',
                                   'op_request', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_DOWNLOAD',
                                   'download', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_APPROVAL',
                                   'approval', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_SEARCH',
                                   'search', undef],
                        ["MENU", "I18N_OPENXPKI_HTML_MENU_PUK_MANAGEMENT",
                                   "puk_management", 'I18N_OPENXPKI_WF_TYPE_PASSWORD_SAFE' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LOGOUT",
                                   "logout", undef ]
                    ],
                    "caop_menu" =>
                    [
                        ['ACTION', 'I18N_OPENXPKI_HTML_MENU_TASKS',
                                   'home', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_REQUEST',
                                   'op_request', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_DOWNLOAD',
                                   'download', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_APPROVAL',
                                   'approval', undef],
                        ['MENU',   'I18N_OPENXPKI_HTML_MENU_SEARCH',
                                   'search', undef],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LOGOUT",
                                   "logout", undef ]
                    ],
                    "user_request" =>
                    [
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CERTIFICATE_SIGNING_REQUEST",
                                   "create_csr", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_SIGNING_REQUEST' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_SMARTCARD_PERSONALIZATION",
                                   "smartcard_personalization", 'I18N_OPENXPKI_WF_TYPE_SMARTCARD_PERSONALIZATION' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CERTIFICATE_REVOCATION_REQUEST",
                                   "create_crr", undef ],
			['ACTION', 'I18N_OPENXPKI_HTML_MENU_RESET_TOKEN', 'reset_token', 'I18N_OPENXPKI_WF_TYPE_SMARTCARD_PERSONALIZATION' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_BULK_CERTIFICATE_SIGNING_REQUEST",
                                   "create_csr_bulk", undef ],
                    ],
                    "op_request" =>
                    [
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CERTIFICATE_SIGNING_REQUEST",
                                   "create_csr", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_SIGNING_REQUEST' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CERTIFICATE_REVOCATION_REQUEST",
                                   "create_crr", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_REVOCATION_REQUEST' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_ISSUE_CRL",
                                   "issue_crl", 'I18N_OPENXPKI_WF_TYPE_CRL_ISSUANCE' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_SMARTCARD_PERSONALIZATION",
                                   "smartcard_personalization", undef ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_SMARTCARD_CARDADM",
                                   "smartcard_admin", undef ],
                    ],
                    'puk_management' =>
                    [
                        [ 'ACTION', 'I18N_OPENXPKI_HTML_MENU_UPLOAD_PUKS', 'upload_puks', undef ],
                        [ 'ACTION', 'I18N_OPENXPKI_HTML_MENU_SHOW_AVAILABLE_PUKS', 'show_available_puks', undef ],
                    ],
                    "download" =>
                    [
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_MY_CERTIFICATES",
                                   "my_certificates", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_SIGNING_REQUEST' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CA_CERTIFICATES",
                                   "issuer_list", undef ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_CRLS",
                                   "crl_list", undef ],
                    ],
                    "approval" =>
                    [
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_PENDING_CSRS",
                                   "show_pending_requests", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_SIGNING_REQUEST' ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_PENDING_CRRS",
                                   "show_pending_crrs", 'I18N_OPENXPKI_WF_TYPE_CERTIFICATE_REVOCATION_REQUEST' ],
                    ],
                    "search" =>
                    [
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_SEARCH_CERTIFICATES",
                                   "cert_search", undef ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LIST_CERTIFICATES",
                                   "cert_list", undef ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_SEARCH_WORKFLOWS",
                                   "workflow_search_instances", undef ],
                        ["ACTION", "I18N_OPENXPKI_HTML_MENU_LIST_WORKFLOWS",
                                   "workflow_list", undef ],
                    ],
                },
                ACTION =>
                {
                    "create_csr" =>
                    {
                        CMD    => "service/create_csr/index.html",
                        PARAMS => {
                            'subject_style' => '00_basic_style',
		            'keytype'      => 'RSA',
			    'PARAMETER_ENC_ALG' => 'aes256',
                        }
                    },
                    "create_csr_bulk" =>
                    {
                        CMD => "service/create_csr/bulk/index.html"
                    },
                    "create_crr" =>
                    {
                        CMD => "service/create_crr/index.html"
                    },
                    "smartcard_personalization" =>
                    {
                        CMD => "service/smartcard_personalization/index.html"
                    },
                    "reset_token" =>
                    {
                        CMD => "service/reset_token/index.html"
                    },
                    "smartcard_unblock" =>
                    {
                        CMD => "service/reset_token/unblock_pin.html"
                    },
                    "upload_puks" =>
                    {
                        CMD => "service/upload_puks/index.html"
                    },
                    "show_available_puks" =>
                    {
                        CMD => "service/upload_puks/show.html"
                    },
                    "smartcard_admin" =>
                    {
                        CMD => "service/smartcard_admin/index.html"
                    },
                    "workflow_list_types" =>
                    {
                        CMD => "service/workflow/list_types.html"
                    },
                    "workflow_list_instances" =>
                    {
                        CMD => "service/workflow/list_instances.html"
                    },
                    'show_pending_requests' => {
                        CMD => 'service/workflow/show_pending_requests.html'
                    },
                    'show_pending_crrs' => {
                        CMD => 'service/workflow/show_pending_crrs.html'
                    },
                    'workflow_search_instances' =>
                     {
                         CMD => 'service/workflow/search_instances.html'
                     },
                    'workflow_list' =>
                     {
                         CMD    => 'service/workflow/search_instances.html',
                         PARAMS => {
                            '__submit' => 1,
                         },
                     },
                    "issuer_list" =>
                    {
                        CMD => "service/api/issuer_list.html"
                    },
                    "crl_list" =>
                    {
                        CMD => "service/api/crl_list.html"
                    },
                    "policy_list" =>
                    {
                        CMD => "service/api/policy_list.html"
                    },
                    "key_list" =>
                    {
                        CMD => "service/api/key_list.html"
                    },
                    "logout" =>
                    {
                        CMD => "service/logout.html"
                    },
                    "cert_search" =>
                    {
                        CMD => "service/api/cert_search.html"
                    },
                    "cert_list" =>
                    {
                        CMD => "service/api/cert_list.html"
                    },
                    "issue_crl" =>
                    {
                        CMD => "service/workflow/create_instance.html",
                        PARAMS => {
                            'type' => 'I18N_OPENXPKI_WF_TYPE_CRL_ISSUANCE',
                        },
                    },
                    "my_certificates" =>
                    {
                        CMD => "service/api/certs_requested_by_user.html",
                    },
                },
               };
</%once>
<%init>
    # get all workflow types
    my $msg = $context->{client}->send_receive_command_msg('list_workflow_titles');
    my @types;
    if (ref $msg->{PARAMS} eq 'HASH') {
        @types = keys %{$msg->{PARAMS}};
    }
    my %params = ( MASON  => $m,
                   CONFIG => $CONFIG,
                   ACTION => "/service/info",
                   COMP   => $m->request_comp()->title() );

    $params{'ROLE'}
	 = $context->{client}->send_receive_command_msg('get_role')->{PARAMS};
    foreach my $key ("SESSION_ID", "LANGUAGE")
    {
        $params{$key} = $context->{lc $key} if (exists $context->{lc $key});
    }
    $params{'AVAILABLE_WORKFLOWS'} = \@types;
    $context->{menu} = OpenXPKI::Client::HTML::Mason::Menu->new(\%params);
    return;
</%init>

<%flags>
  inherit => '/syshandler'
</%flags>
